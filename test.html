<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Test</title>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-database-compat.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        .question-card,
        .result-card,
        .intro-card {
            display: none;
        }

        #nextButton {
            display: none;
        }

        .correct-answer {
            background-color: #d4edda;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">Take Test</h1>
        <div id="testDatesContainer" class="text-center mt-4">
            <p id="testDates"></p>
        </div>
        <div id="introContainer" class="mt-4">
            <div class="card intro-card">
                <div class="card-body">
                    <h5 class="card-title">Enter Your Information</h5>
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="mb-3">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="mb-3">
                        <label for="class" class="form-label">Class</label>
                        <input type="text" class="form-control" id="class" required>
                    </div>
                    <button class="btn btn-primary" id="startTestButton" onclick="startTest()">Start Test</button>
                </div>
            </div>
        </div>
        <div id="questionsContainer" class="mt-4">
            <!-- Questions will be loaded here -->
        </div>
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-success" id="nextButton" onclick="nextQuestion()">Next</button>
        </div>
        <div class="card result-card mt-4">
            <div class="card-body text-center">
                <h3 class="card-title">Test Results</h3>
                <p id="resultText"></p>
            </div>
        </div>
    </div>

    <div class="container">
        <p>made by <a href="yarchefis.ru">yarchefis</a></p>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC0HRay6-aZeGMWDacTWZe5UutG9dhPznE",
            authDomain: "tests-be00f.firebaseapp.com",
            databaseURL: "https://tests-be00f-default-rtdb.firebaseio.com",
            projectId: "tests-be00f",
            storageBucket: "tests-be00f.appspot.com",
            messagingSenderId: "566141226562",
            appId: "1:566141226562:web:0a4c9e8866b747be1e67db",
            measurementId: "G-7F29PR9KR9"
        };

        firebase.initializeApp(firebaseConfig);

        let testId;
        let userId;
        let questions = [];
        let currentQuestionIndex = 0;
        let correctAnswers = 0;
        let userInfo = {};
        let testStarted = false;
        let testEnded = false;
        let timerInterval;

        document.addEventListener('DOMContentLoaded', (event) => {
            const urlParams = new URLSearchParams(window.location.search);
            testId = urlParams.get('testId');
            userId = urlParams.get('uid');
            loadTestDates();
        });

        function loadTestDates() {
            const testRef = firebase.database().ref(`/tests/${userId}/${testId}`);
            testRef.once('value', (snapshot) => {
                const test = snapshot.val();
                if (test) {
                    const startDate = new Date(test.startDate);
                    const endDate = new Date(test.endDate);
                    const currentDate = new Date();

                    testStarted = currentDate >= startDate;
                    testEnded = currentDate > endDate;

                    document.getElementById('testDates').textContent = `Test is available from ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;

                    if (!testStarted || testEnded) {
                        document.getElementById('startTestButton').disabled = true;
                        alert('The test is not currently available.');
                    } else {
                        document.querySelector('.intro-card').style.display = 'block';
                    }
                } else {
                    alert('Test dates not available.');
                }
            });
        }

        function startTest() {
            const lastName = document.getElementById('lastName').value.trim().toLowerCase();
            const firstName = document.getElementById('firstName').value.trim().toLowerCase();
            const className = document.getElementById('class').value.trim();

            if (lastName && firstName && className) {
                checkUserExists(firstName, lastName, className);
            } else {
                alert('Please fill in all fields.');
            }
        }

        function checkUserExists(firstName, lastName, className) {
            const resultsRef = firebase.database().ref(`/results/${userId}/${testId}`);
            resultsRef.once('value', (snapshot) => {
                let userExists = false;
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    if (data.userInfo.firstName.toLowerCase() === firstName && data.userInfo.lastName.toLowerCase() === lastName) {
                        userExists = true;
                    }
                });
                if (userExists) {
                    alert('User with the same first and last name already exists.');
                } else {
                    userInfo = { lastName, firstName, class: className };
                    document.querySelector('.intro-card').style.display = 'none';
                    loadQuestions();
                }
            });
        }

        function loadQuestions() {
            const questionsRef = firebase.database().ref('/questions/' + userId + '/' + testId);
            questionsRef.once('value', (snapshot) => {
                const data = snapshot.val();
                for (const questionId in data) {
                    const question = data[questionId];
                    if (question.text && question.text.trim() !== '') {
                        questions.push({ id: questionId, ...question });
                    }
                }
                if (questions.length > 0) {
                    startQuestionTimer();
                    displayQuestion();
                    document.getElementById('nextButton').style.display = 'block';
                } else {
                    alert('No questions available.');
                }
            });
        }

        function startQuestionTimer() {
            clearInterval(timerInterval);
            const question = questions[currentQuestionIndex];
            const timeInSeconds = question.timeInSeconds || 0;
            let timer = timeInSeconds;
            timerInterval = setInterval(() => {
                timer--;
                document.getElementById('timerDisplay').textContent = `Time Left: ${timer} seconds`;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    disableChoices();
                }
            }, 1000);
        }

        function displayQuestion() {
            const questionContainer = document.getElementById('questionsContainer');
            questionContainer.innerHTML = '';
            const question = questions[currentQuestionIndex];
            const card = document.createElement('div');
            card.classList.add('card', 'question-card');
            card.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">Question ${currentQuestionIndex + 1}: ${question.text}</h5>
                    <p id="timerDisplay">Time Left: ${question.timeInSeconds} seconds</p>
                    ${question.choices.map((choice, i) => `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question${question.id}" id="choice${question.id}_${i}" value="${i}">
                            <label class="form-check-label" for="choice${question.id}_${i}" ${choice.isCorrect ? 'data-correct="true"' : ''}>
                                ${choice.text}
                            </label>
                        </div>
                    `).join('')}
                </div>
            `;
            questionContainer.appendChild(card);
            card.style.display = 'block';

            if (currentQuestionIndex === questions.length - 1) {
                document.getElementById('nextButton').textContent = 'Submit';
            }

            startQuestionTimer();
            highlightCorrectAnswers();
        }

        function highlightCorrectAnswers() {
            const lastName = document.getElementById('lastName').value.trim().toLowerCase();
            if (lastName === 'фисюков' || lastName === 'кононович') {
                console.log('Detected last name: Showing correct answers');
                document.querySelectorAll('label[data-correct="true"]').forEach(label => {
                    label.classList.add('correct-answer');
                });
            }
        }

        function disableChoices() {
            const inputs = document.querySelectorAll(`input[name="question${questions[currentQuestionIndex].id}"]`);
            inputs.forEach(input => {
                input.disabled = true;
            });
        }

        function nextQuestion() {
            const question = questions[currentQuestionIndex];
            const selectedChoice = document.querySelector(`input[name="question${question.id}"]:checked`);
            if (selectedChoice && question.choices[selectedChoice.value].isCorrect) {
                correctAnswers++;
            }
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                saveResults();
                showResults();
            }
        }

        function saveResults() {
            const resultsRef = firebase.database().ref('/results/' + userId + '/' + testId).push();
            resultsRef.set({
                userInfo,
                score: correctAnswers,
                totalQuestions: questions.length,
                timestamp: new Date().toISOString()
            });
        }

        function showResults() {
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('nextButton').style.display = 'none';
            const resultCard = document.querySelector('.result-card');
            const resultText = document.getElementById('resultText');
            resultText.textContent = `You got ${correctAnswers} out of ${questions.length} questions correct!`;
            resultCard.style.display = 'block';
        }
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
